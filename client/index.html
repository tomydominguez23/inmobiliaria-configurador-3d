                        document.exitFullscreen();
                    }
                }
                console.log('Toggled fullscreen');
            } catch (error) {
                console.error('Error toggling fullscreen:', error);
            }
        }

        function saveDesign() {
            try {
                const nameElement = document.getElementById('designName');
                const name = nameElement ? nameElement.value : '';
                
                if (!name) {
                    showToast('Por favor ingresa un nombre para el diseño', 'error');
                    return;
                }
                
                const design = {
                    name: name,
                    room: currentRoom,
                    furniture: selectedFurniture,
                    timestamp: new Date().toISOString()
                };
                
                // Save to localStorage
                localStorage.setItem(`design_${Date.now()}`, JSON.stringify(design));
                
                closeModal('saveModal');
                showToast(`Diseño "${name}" guardado exitosamente`, 'success');
                console.log(`Saved design: ${name}`);
            } catch (error) {
                console.error('Error saving design:', error);
                showToast('Error al guardar diseño', 'error');
            }
        }

        function shareDesign() {
            try {
                const url = window.location.href + `?room=${currentRoom}&furniture=${selectedFurniture.map(f => f.id).join(',')}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'Mi configuración 3D',
                        text: 'Mira mi diseño de interior personalizado',
                        url: url
                    });
                } else {
                    navigator.clipboard.writeText(url).then(() => {
                        showToast('Enlace copiado al portapapeles', 'success');
                    }).catch(() => {
                        showToast('No se pudo copiar el enlace', 'error');
                    });
                }
                
                console.log('Shared design');
            } catch (error) {
                console.error('Error sharing design:', error);
                showToast('Error al compartir diseño', 'error');
            }
        }

        function exportFurnitureList() {
            try {
                if (selectedFurniture.length === 0) {
                    showToast('No hay muebles para exportar', 'error');
                    return;
                }
                
                let csv = 'Mueble,Categoría,Precio,Habitación\n';
                selectedFurniture.forEach(furniture => {
                    csv += `"${furniture.name}","${furniture.category}","$${furniture.price}","${furniture.room}"\n`;
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'lista-muebles.csv';
                link.click();
                
                showToast('Lista exportada como CSV', 'success');
                console.log('Exported furniture list');
            } catch (error) {
                console.error('Error exporting furniture list:', error);
                showToast('Error al exportar lista', 'error');
            }
        }

        function requestQuote() {
            try {
                if (selectedFurniture.length === 0) {
                    showToast('Agrega muebles antes de solicitar cotización', 'error');
                    return;
                }
                
                const total = selectedFurniture.reduce((sum, furniture) => sum + furniture.price, 0);
                const message = `Hola! Me interesa cotizar los siguientes muebles:\n\n${selectedFurniture.map(f => `- ${f.name}: $${f.price.toLocaleString()}`).join('\n')}\n\nTotal: $${total.toLocaleString()}\n\nQuedo atento a su respuesta.`;
                
                const whatsappUrl = `https://wa.me/56912345678?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                
                showToast('Redirigiendo a WhatsApp para cotización', 'success');
                console.log('Requested quote via WhatsApp');
            } catch (error) {
                console.error('Error requesting quote:', error);
                showToast('Error al solicitar cotización', 'error');
            }
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
            } catch (error) {
                console.error('Error closing modal:', error);
            }
        }

        function showToast(message, type = 'info') {
            try {
                const container = document.getElementById('toastContainer');
                if (!container) return;
                
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    toast.remove();
                }, 3000);

                console.log(`Toast: ${message} (${type})`);
            } catch (error) {
                console.error('Error showing toast:', error);
            }
        }

        function hideLoading() {
            try {
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loadingOverlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.display = 'none';
                    }
                }, 1000);
                console.log('Loading overlay hidden');
            } catch (error) {
                console.error('Error hiding loading:', error);
            }
        }

        function animate() {
            try {
                requestAnimationFrame(animate);
                
                // Update FPS counter
                const now = performance.now();
                const fps = Math.round(1000 / (now - (window.lastFrameTime || now)));
                const fpsElement = document.getElementById('fpsCounter');
                if (fpsElement) {
                    fpsElement.textContent = Math.min(fps, 60);
                }
                window.lastFrameTime = now;
                
                if (renderer && scene && camera) {
                    renderer.render(scene, camera);
                }
            } catch (error) {
                console.error('Error in animation loop:', error);
            }
        }

        function onWindowResize() {
            try {
                const container = document.getElementById('viewer3d');
                if (!container || !camera || !renderer) return;
                
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
                
                console.log('Window resized, updated 3D viewport');
            } catch (error) {
                console.error('Error handling window resize:', error);
            }
        }

        // Drop zone for furniture
        const viewer3d = document.getElementById('viewer3d');
        if (viewer3d) {
            viewer3d.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            viewer3d.addEventListener('drop', (e) => {
                e.preventDefault();
                try {
                    const furnitureId = parseInt(e.dataTransfer.getData('text/plain'));
                    const furniture = furnitureDatabase.find(f => f.id === furnitureId);
                    if (furniture) {
                        addFurnitureToScene(furniture);
                    }
                } catch (error) {
                    console.error('Error handling drop:', error);
                }
            });
        }

        // Global error handler
        window.addEventListener('error', (e) => {
            console.error('Global error:', e.error);
            showToast('Error inesperado en la aplicación', 'error');
        });

        // Prevent right-click context menu on 3D viewer
        document.addEventListener('contextmenu', (e) => {
            if (e.target.tagName === 'CANVAS') {
                e.preventDefault();
            }
        });

        console.log('Configurador 3D Inmobiliario - All scripts loaded successfully');
    </script>
</body>
</html>